<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <title>Chart of Accounts (Read-Only)</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="chart_override.css">
</head>

<body class="has-sidebar">

<header class="topbar">
  <button class="btn" id="calendarToggleBtn">Calendar</button>
  <div class="datetime" id="dateTime"></div>
  <div class="user">
    <img id="userAvatar" src="profile.png" alt="User">
    <span id="userName"></span>
  </div>
</header>
<script>
  const name = localStorage.getItem('username') || 'User';
  const el = document.getElementById('userName');
  if (el) el.textContent = name;
  function updateClock(){
    const now = new Date();
    const options = { weekday:'short', year:'numeric', month:'short', day:'numeric',
                      hour:'2-digit', minute:'2-digit', second:'2-digit' };
    document.getElementById('dateTime').textContent = now.toLocaleString(undefined, options);
  }
  updateClock(); setInterval(updateClock,1000);
</script>

<div class="app">

  <!-- Keep the original (non-admin) sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <img src="HHAlogo.jpg" alt="HHA Logo"><span>HHA</span>
    </div>
    <ul class="nav">
      <li><a href="Dashboard.html">Dashboard</a></li>
      <li><a href="ChartOfAccounts.ReadOnly.html" aria-current="page">Chart of Accounts</a></li>
      <li><a href="#accounts">Accounts</a></li>
      <li><a href="journal.html">Journalize</a></li>
      <li><a href="trial_balance.html">Trial Balance</a></li>
      <li><a href="#income">Income Statement</a></li>
      <li><a href="#balance">Balance Sheet</a></li>
      <li><a href="#retained">Statement of Retained Earnings</a></li>
    </ul>
    <div class="sidebar-footer"><button class="btn">Logout</button></div>
  </aside>

  <main class="main">
    <div class="header">
      <h1>Chart of Accounts</h1>
      <!-- Read-only: search only -->
      <div class="form-actions">
        <input id="searchInput" type="text" placeholder="Search by name or number">
        <button id="searchBtn">Search</button>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Account Number</th><th>Name</th><th>Type</th><th>Term</th>
            <th>Balance</th><th>Created By</th><th>Date Created</th><th>Comments</th>
          </tr>
        </thead>
        <tbody id="accountTableBody"><tr><td colspan="8"></td></tr></tbody>
      </table>
    </div>
  </main>
</div>

<div id="calendarContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>
<script>
  // If your RBAC initializer exists, keep it
  if (typeof initRBAC === 'function') initRBAC();

  const db = window.supabaseClient;

  async function loadAccounts(searchTerm = "") {
    // base query: only active accounts
    let query = db.from('accounts')
      .select('*')
      .eq('is_active', true)
      .order('account_number', { ascending: true });

    if (searchTerm) {
      // Simple client-side filter fallback: fetch and filter.
      // If you have a text index, replace with ilike or FTS.
      const { data, error } = await db
        .from('accounts')
        .select('*')
        .eq('is_active', true)
        .order('account_number', { ascending: true });

      renderAccounts(
        error ? [] : data.filter(a =>
          (a.account_name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
          (a.account_number || '').toString().includes(searchTerm)
        ),
        error
      );
      return;
    }

    const { data, error } = await query;
    renderAccounts(data, error);
  }

  function renderAccounts(data, error) {
    const tbody = document.getElementById('accountTableBody');
    tbody.innerHTML = '';

    if (error) {
      console.error("Error loading accounts:", error.message);
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:red;">Error loading data</td></tr>';
      return;
    }

    if (!data || !data.length) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No accounts found</td></tr>';
      return;
    }

            data.forEach(acc => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${acc.account_number}</td>
        <td>
          <a href="ledger.html?account_id=${encodeURIComponent(acc.account_id)}" class="link">
            ${acc.account_name}
          </a>
        </td>
        <td>${acc.account_category}</td>
        <td>${acc.normal_side}</td>
        <td>${Number(acc.balance ?? acc.initial_balance ?? 0).toFixed(2)}</td>
        <td>${acc.user_id || 'N/A'}</td>
        <td>${acc.date_added ? new Date(acc.date_added).toLocaleDateString() : ''}</td>
        <td>${acc.comment || ''}</td>
      `;
      tbody.appendChild(row);
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadAccounts();

    // Search handlers
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    searchBtn.addEventListener('click', () => loadAccounts(searchInput.value.trim()));
    searchInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') loadAccounts(searchInput.value.trim());
    });

    // Load calendar fragment and execute its <script> tags
    fetch('Calendar.html')
      .then(res => res.text())
      .then(html => {
        const container = document.getElementById('calendarContainer');
        container.innerHTML = html;
        const scripts = container.querySelectorAll('script');
        scripts.forEach(oldScript => {
          const newScript = document.createElement('script');
          newScript.textContent = oldScript.textContent;
          document.body.appendChild(newScript);
        });
      });
  });
</script>
</body>
</html>
