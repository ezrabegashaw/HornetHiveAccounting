<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8" />
  <title>Forgot Password • Hornet Hive Accounting</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="auth.css">
  <style>
    /* Optional: small page-specific tweaks if needed */
    .helper-text { font-size: .9rem; opacity: .85; margin-top: .5rem; line-height: 1.3; }
    .alert { display:none; padding:.75rem 1rem; border-radius:8px; margin:.75rem 0 0; }
    .alert.success { background: #e6ffed; border:1px solid #a4e5b7; }
    .alert.error { background: #ffecec; border:1px solid #ffb3b3; }
    .login-btn[disabled] { opacity: .6; cursor: not-allowed; }
    .links { display:flex; gap:1rem; justify-content:center; margin-top:.75rem; }

    /* Simple two-field grid */
    .form-grid { display:grid; gap:.6rem; }
    @media (min-width: 560px){
      .form-grid { grid-template-columns: 1fr 1fr; }
      .form-grid .full { grid-column: 1 / -1; }
    }
    .field-label { font-size:.9rem; margin-bottom:.25rem; display:block; }
  </style>
</head>

<body class="auth-page">
  <header class="topbar">
    <div class="datetime" id="dateTime"></div>
  </header>

  <script>
    function updateClock(){
      const now = new Date();
      const options = {
        weekday:'short', year:'numeric', month:'short', day:'numeric',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      };
      document.getElementById('dateTime').textContent = now.toLocaleString(undefined, options);
    }
    updateClock();
    setInterval(updateClock, 1000);
  </script>

  <div class="auth-shell">
    <div class="logo-container">
      <img class="logo" src="HHAlogo.jpg" alt="HHA Logo">
    </div>

    <div class="login-box" role="main" aria-labelledby="page-title">
      <header>
        <h1 id="page-title">Hornet Hive Accounting</h1>
      </header>

      <main>
        <div class="login-container" aria-live="polite">
          <h2>Forgot Password</h2>
          <p class="helper-text">
            Enter the email and User ID associated with your account. If they match our records,
            we’ll send a link to reset your password.
          </p>

          <form id="forgot-form" novalidate>
            <div class="form-grid">
              <div>
                <label for="fp-email" class="field-label">Email</label>
                <input
                  type="email"
                  id="fp-email"
                  name="email"
                  placeholder="you@example.com"
                  autocomplete="email"
                  required
                  inputmode="email"
                  aria-required="true"
                >
              </div>

              <div>
                <label for="fp-userid" class="field-label">User ID</label>
                <input
                  type="text"
                  id="fp-userid"
                  name="userId"
                  placeholder="Your User ID"
                  autocomplete="username"
                  required
                  minlength="2"
                  aria-required="true"
                >
              </div>

              <div class="full">
                <button type="submit" class="login-btn" id="fp-submit">Send reset link</button>
              </div>
            </div>

            <div class="links">
              <a href="HornetHiveLogin.html" id="back-to-login">Back to login</a>
            </div>

            <div id="fp-success" class="alert success" role="status" aria-live="polite"></div>
            <div id="fp-error" class="alert error" role="alert" aria-live="assertive"></div>
          </form>
        </div>
      </main>
    </div>
  </div>

  <script>
    // CONFIGURE THESE TO BACKEND
    const USE_SUPABASE = false; // set to true when switching to Supabase
    const SUPABASE_URL = "";    
    const SUPABASE_ANON = "";  
    const RESET_REDIRECT_URL = window.location.origin + "/reset.html"; // where users land after clicking email link
    const LEGACY_API_ENDPOINT = "/api/auth/forgot"; // BACKEND ENDPOINT

    const form = document.getElementById('forgot-form');
    const emailEl = document.getElementById('fp-email');
    const userIdEl = document.getElementById('fp-userid');
    const submitBtn = document.getElementById('fp-submit');
    const successEl = document.getElementById('fp-success');
    const errorEl = document.getElementById('fp-error');

    function show(el, msg) { el.textContent = msg; el.style.display = 'block'; }
    function hide(el) { el.textContent = ""; el.style.display = 'none'; }

    async function sendLegacyReset(email, userId) {
      // POST to your server that validates email+userId and sends reset email.
      const res = await fetch(LEGACY_API_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, userId })
      });
      if (!res.ok) {
        let msg = "Unable to process your request.";
        try {
          const data = await res.json();
          if (data?.error) msg = data.error;
        } catch (_) {}
        throw new Error(msg);
      }
      return true;
    }

    async function sendSupabaseReset(email, userId) {
      // Supabase requires email for reset. If you want to validate userId,
      // do that on your backend BEFORE calling this.
      if (!window.supabase) throw new Error("Supabase client not loaded.");
      const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      const { error } = await supa.auth.resetPasswordForEmail(email, {
        redirectTo: RESET_REDIRECT_URL
      });
      if (error) throw error;
      return true;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hide(successEl); hide(errorEl);

      const email = emailEl.value.trim();
      const userId = userIdEl.value.trim();

      if (!email) {
        show(errorEl, "Please enter your email address.");
        emailEl.focus();
        return;
      }
      if (!emailEl.checkValidity()) {
        show(errorEl, "Please provide a valid email address.");
        emailEl.focus();
        return;
      }
      if (!userId) {
        show(errorEl, "Please enter your User ID.");
        userIdEl.focus();
        return;
      }
      if (!userIdEl.checkValidity()) {
        show(errorEl, "User ID must be at least 2 characters.");
        userIdEl.focus();
        return;
      }

      submitBtn.disabled = true;

      try {
        if (USE_SUPABASE) {
          await sendSupabaseReset(email, userId);
        } else {
          await sendLegacyReset(email, userId);
        }
        show(successEl, "If the email and User ID match an account, a reset link has been sent.");
        form.reset();
      } catch (err) {
        show(errorEl, err.message || "Something went wrong sending the reset link.");
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>

  <!-- Enable this when you switch to Supabase (and set USE_SUPABASE = true):
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  -->
</body>
</html>
