<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Update Password â€¢ Hornet Hive Accounting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="auth.css">
  <style>
    .helper-text { font-size: .9rem; opacity: .85; margin-top: .5rem; line-height: 1.3; }
    .alert { display:none; padding:.75rem 1rem; border-radius:8px; margin:.75rem 0 0; }
    .alert.success { background: #e6ffed; border:1px solid #a4e5b7; }
    .alert.error { background: #ffecec; border:1px solid #ffb3b3; }
    .login-btn[disabled] { opacity: .6; cursor: not-allowed; }
    .links { display:flex; gap:1rem; justify-content:center; margin-top:.75rem; }
  </style>
</head>
<body class="auth-page">

<header class="topbar">
  <div class="datetime" id="dateTime"></div>
</header>

<script>
  function updateClock() {
    const now = new Date();
    const options = { weekday:'short', year:'numeric', month:'short', day:'numeric',
                      hour:'2-digit', minute:'2-digit', second:'2-digit' };
    document.getElementById('dateTime').textContent = now.toLocaleString(undefined, options);
  }
  updateClock();
  setInterval(updateClock, 1000);
</script>

<div class="auth-shell">
  <div class="logo-container">
    <img class="logo" src="HHAlogo.jpg" alt="HHA Logo">
  </div>

  <div class="login-box" role="main" aria-labelledby="page-title">
    <header>
      <h1 id="page-title">Hornet Hive Accounting</h1>
    </header>

    <main>
      <div class="login-container" aria-live="polite">
        <h2>Update Password</h2>
        <p class="helper-text">
          Enter your email, User ID (username), and your new password below.
        </p>

        <form id="update-form" novalidate>
          <input type="email" id="fp-email" placeholder="Email" required>
          <input type="text" id="fp-userid" placeholder="User ID (Username)" required>
          <input type="password" id="new-password" placeholder="New Password" required>
          <button type="submit" class="login-btn" id="update-btn">Update Password</button>

          <div class="links">
            <a href="HornetHiveLogin.html">Back to login</a>
          </div>

          <div id="update-success" class="alert success" role="status" aria-live="polite"></div>
          <div id="update-error" class="alert error" role="alert" aria-live="assertive"></div>
        </form>
      </div>
    </main>
  </div>
</div>

<script>
  const form = document.getElementById('update-form');
  const emailEl = document.getElementById('fp-email');
  const userIdEl = document.getElementById('fp-userid');
  const passwordEl = document.getElementById('new-password');
  const submitBtn = document.getElementById('update-btn');
  const successEl = document.getElementById('update-success');
  const errorEl = document.getElementById('update-error');

  function show(el, msg) { el.textContent = msg; el.style.display = 'block'; }
  function hide(el) { el.textContent = ""; el.style.display = 'none'; }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hide(successEl); hide(errorEl);
    submitBtn.disabled = true;

    const email = emailEl.value.trim();
    const username = userIdEl.value.trim();
    const newPassword = passwordEl.value;

    if (!email || !username || !newPassword) {
      show(errorEl, "All fields are required.");
      submitBtn.disabled = false;
      return;
    }

    try {
      const res = await fetch('http://localhost:3000/api/update-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, username, newPassword })
      });

      const data = await res.json();

      if (!res.ok) throw new Error(data.message || "Failed to update password.");

      show(successEl, "Password updated successfully! You can now log in.");
      form.reset();
    } catch (err) {
      console.error(err);
      show(errorEl, err.message || "Something went wrong.");
    } finally {
      submitBtn.disabled = false;
    }
  });

</script>

</body>
</html>
