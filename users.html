<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <title>Hornet Hive Accounting - Users</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="users.css">
</head>

<body class="has-sidebar">

<header class="topbar">
  <div class="datetime" id="dateTime"></div>
  <div class="user">
    <img id="userAvatar" src="profile.png" alt="User">
    <span id="userName"></span>
  </div>
</header>
<script>
  const name = localStorage.getItem('first_name') || 'User';
  const el = document.getElementById('userName');
  if (el) el.textContent = name;
  function updateClock(){
    const now = new Date();
    const options = { weekday:'short', year:'numeric', month:'short', day:'numeric',
                      hour:'2-digit', minute:'2-digit', second:'2-digit' };
    document.getElementById('dateTime').textContent = now.toLocaleString(undefined, options);
  }
  updateClock(); setInterval(updateClock,1000);
</script>

<div class="app">

  <!-- ADMIN SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <img src="HHAlogo.jpg" alt="HHA Logo"><span>HHA</span>
    </div>
    <ul class="nav">
      <li><a href="AdminDashboard.html" aria-current="page">Dashboard</a></li>
      <li><a href="AdminChartOfAccounts.html">Chart of Accounts</a></li>
      <li><a href="Accounts.html">Accounts</a></li>
      <li><a href="Users.html">Users</a></li>
      <li><a href="EventLogs.html">Event Logs</a></li>
    </ul>
    <div class="sidebar-footer"><button class="btn">Logout</button></div>
  </aside>


  
  <main class="main">
    <div class="header">
        <h1>Users</h1>
        <div class="form-actions">
          <input id="searchInput" type="text" placeholder="Search by name">
          <button id="searchBtn">Search</button>
          <button id="queryUsers">View Pending Uers</button>
        </div>
    </div>

    <!--Displays Current Users-->
    <div class="table-wrap">
      <table id="userTable">
        <thead>
          <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Role</th>
            <th>Active</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!--Edit Pop-up Display-->
    <div class="popup-overlay" id="editPopupOverlay"></div>
    <div class="popup" id="editPopup">
      <h3>Edit User</h3>
      <form id="editUserForm">
        <label>First Name:</label>
        <input id="editFirstName" type="text">
        <label>Last Name</label>
        <input id="editLastName" type="text">
        <label>Role</label>
        <select id="editRole">
          <option value="Admin">Admin</option>
          <option value="Manager">Manager</option>
          <option value="Accountant">Accountant</option>
        </select>
        <label>Active</label>
        <input id="editActive" type="checkbox">
        <!-- hidden native submit kept to ensure form.requestSubmit() triggers form's submit event -->
        <input id="hiddenEditSubmit" type="submit" value="Submit" style="display:none">
      </form>
      

      <div class="popup-buttons">
        <button id="saveButton" type="button">Save</button>
        <button class='popup-cancel' id="cancelButton">Cancel</button>
        <button class='popup-delete' id="deleteButton">Delete</button>
      </div>
    </div>


    <!--Pending Users Pop-up Display-->
    <div class="popup-overlay" id="pendingUsersOverlay"></div>
    <div class="popup-pending" id="pendingPopup">
      <h3>Pending Users</h3>
      <div class="table-wrap">
        <table id="pendingTable">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>    

  </main>

</div>

<script src="'users.js">
  
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>
<script type="module">

  //Import createClient from global supabase object
  const { createClient } = supabase;

  //Supabase project info
  const SUPABASE_URL = "https://rsthdogcmqwcdbqppsrm.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzdGhkb2djbXF3Y2RicXBwc3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNTY3NDcsImV4cCI6MjA3MTYzMjc0N30.EoOxjSIjGHbw6ltNisWYq6yKXdrOfE6XVdh5mERbrSY";

  //Initialize Supabase client
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.USE_SUPABASE = true;

  //Load users onto a table
  async function getUsers() {
    const {data, error} = await supabaseClient
      .from('users')
      .select('*')
      .eq('approved', true);

      const tableBody = document.getElementById('userTable').getElementsByTagName('tbody')[0];
      tableBody.innerHTML = ''; // Clear existing rows

      data.forEach(user => {
        const newRow = tableBody.insertRow();

        const email = newRow.insertCell(0);
        email.textContent = user.email;

        const name = newRow.insertCell(1);
        name.textContent = user.first_name + " " + user.last_name;

        const role = newRow.insertCell(2);
        role.textContent = user.role;

        const active = newRow.insertCell(3);
        active.textContent = user.active ? '✅' : '❌';

        //Action Buttons

        const actionCell = newRow.insertCell(4);
        const editButton = document.createElement('button');
        editButton.textContent = 'Edit';
        editButton.className = 'edit-btn';
        editButton.onclick = () => showEditPopup(user);
        actionCell.appendChild(editButton);


      });
  }

   async function showEditPopup(user) {
      // Fill the form with current user data
      document.getElementById('editFirstName').value = user.first_name;
      document.getElementById('editLastName').value = user.last_name;
      document.getElementById('editRole').value = user.role;
      document.getElementById('editActive').checked = user.active;
      
      // Show the popup
      document.getElementById('editPopupOverlay').style.display = 'block';
      document.getElementById('editPopup').style.display = 'block';

      // Handle form submission
      const form = document.getElementById('editUserForm');
      form.onsubmit = async (e) => {
          e.preventDefault();
          const updates = {
              first_name: document.getElementById('editFirstName').value,
              last_name: document.getElementById('editLastName').value,
              role: document.getElementById('editRole').value,
              active: document.getElementById('editActive').checked
          };
      
          const success = await updateUser(user.id, updates);
          if (success) {
              await getUsers(); // Refresh the table with updated data
              closePopup();
          }
      };

      // Wire up delete button
      const deleteBtn = document.getElementById('deleteButton');
      if (deleteBtn) {
          // Use onclick to ensure only one handler is attached
          deleteBtn.onclick = async () => {
              await deleteUser(user.id);
              // Refresh table and close popup after successful deletion
              await getUsers();
              closePopup();
          };
      }

      
  }
  //Updates users information
  async function updateUser(userID, updates) {
    const {error} = await supabaseClient
    .from('users')
    .update({
      first_name: updates.first_name,
      last_name: updates.last_name,
      role: updates.role,
      active: updates.active
    })
    .eq('id', userID);

    if (error) {
      console.error("Error approving user:", error);
      return false;
    }
    return true;
  }

  //Deletes the user from the database
  async function deleteUser(userID) {
    const text = "Do you wish to reject this user?";
    if (confirm(text) !== true) {
      return false;
    }

    const {error} = await supabaseClient
      .from('users')
      .delete()
      .eq('id', userID);

    if (error) {
      console.error('Error rejecting user:', error);
      return false;
    }

    return true;
  }

  function closePopup() {
    document.getElementById('editPopupOverlay').style.display = 'none';
    document.getElementById('editPopup').style.display = 'none';
    document.getElementById('pendingUsersOverlay').style.display = 'none';
    document.getElementById('pendingPopup').style.display = 'none';
  }

  document.getElementById('editPopupOverlay').onclick = closePopup;
  document.getElementById('cancelButton').onclick = closePopup;
  document.getElementById('pendingUsersOverlay').onclick = closePopup;
    
  getUsers();

  // Wire Save button to submit the edit form
  const saveBtn = document.getElementById('saveButton');
  const editForm = document.getElementById('editUserForm');
  if (saveBtn && editForm) {
    saveBtn.addEventListener('click', () => {
      // Use requestSubmit to trigger the form's submit event and validation
      if (typeof editForm.requestSubmit === 'function') editForm.requestSubmit();
      else editForm.dispatchEvent(new Event('submit', {cancelable: true}));
    });
  }

  document.getElementById('queryUsers').onclick = showPendingPopup;
  async function showPendingPopup() {
    document.getElementById('pendingUsersOverlay').style.display = 'block';
    document.getElementById('pendingPopup').style.display = 'block';

    //Prints users onto the table
    const tableBody = document.getElementById('pendingTable').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = ''; // Clear existing rows

    const {data, error} = await supabaseClient
      .from('users')
      .select('*')
      .eq('approved', false);

    data.forEach(user => {
        const newRow = tableBody.insertRow();

        const email = newRow.insertCell(0);
        email.textContent = user.email;

        const name = newRow.insertCell(1);
        name.textContent = user.first_name + " " + user.last_name;

        const role = newRow.insertCell(2);
        role.textContent = user.role;

        //Action
        const actionCell = newRow.insertCell(3);
        const approveButton = document.createElement('button');
        approveButton.textContent = 'Approve';
        approveButton.className = 'approve-btn';
        approveButton.onclick = () => approveUser(user.id);

        const rejectButton = document.createElement('button');
        rejectButton.textContent = 'Reject';
        rejectButton.className = 'reject-btn';
        rejectButton.onclick = () => rejectUser(user.id);
        
        actionCell.appendChild(approveButton);
        actionCell.appendChild(rejectButton);
    });

    document.getElementById('confirmReject').onclick = async () => {
    await rejectUser(userID);
    closePopup();
    };
  }

  async function approveUser(userID) {
    const {error} = await supabaseClient
      .from('users')
      .update({approved: true, active: true})
      .eq('id', userID)

      showPendingPopup();
  }

  async function rejectUser(userID) {
    const text = "Do you wish to remove this user?";
    if (confirm(text) !== true) {
      return false;
    }
    const {error} = await supabaseClient
        .from('users')
        .delete()
        .eq('id', userID);

        if (error) {
      console.error('Error deleting user:', error);
      return false;
    }
    showPendingPopup();
    return true; 
  }

</script>



</body>
</html>
