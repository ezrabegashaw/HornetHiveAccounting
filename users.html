<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <title>Hornet Hive Accounting - Users</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="users.css">
</head>

<body class="has-sidebar">

<header class="topbar">
  <div class="datetime" id="dateTime"></div>
  <div class="user">
    <img id="userAvatar" src="profile.png" alt="User">
    <span id="userName"></span>
  </div>
</header>
<script>
  const name = localStorage.getItem('first_name') || 'User';
  const el = document.getElementById('userName');
  if (el) el.textContent = name;
  function updateClock(){
    const now = new Date();
    const options = { weekday:'short', year:'numeric', month:'short', day:'numeric',
                      hour:'2-digit', minute:'2-digit', second:'2-digit' };
    document.getElementById('dateTime').textContent = now.toLocaleString(undefined, options);
  }
    updateClock(); setInterval(updateClock, 1000);

    // Help button behavior
    document.getElementById('helpBtn').addEventListener('click', () => {
        window.open('usersHelp.html', '_blank');
    });

</script>

<div class="app">

  <!-- ADMIN SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <img src="HHAlogo.jpg" alt="HHA Logo"><span>HHA</span>
    </div>
    <ul class="nav">
      <li><a href="AdminDashBoard.html">Dashboard</a></li>
      <li><a href="AdminChartOfAccounts.html">Chart of Accounts</a></li>
      <li><a href="Accounts.html">Accounts</a></li>
      <li><a href="Users.html" aria-current="page">Users</a></li>
      <li><a href="EventLogs.html">Event Logs</a></li>
    </ul>
    <div class="sidebar-footer"><button class="btn" id="logoutBtn">Logout</button></div>
  </aside>


  
  <main class="main">
    <div class="header">
        <h1>Users</h1>
        <div class="form-actions">
          <input id="searchInput" type="text" placeholder="Search by name">
          <button id="searchBtn">Search</button>
          <button id="queryUsers">View Pending Uers</button>
          <button id='createNewUsers'>Create New User</button>
        </div>
    </div>

    <!--Displays Current Users-->
    <div class="table-wrap">
      <table id="userTable">
        <thead>
          <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Role</th>
            <th>Active</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!--Edit Pop-up Display-->
    <div class="popup-overlay" id="popupOverlay"></div>
    <div class="popup" id="editPopup">
      <h3>Edit User</h3>
      <form id="editUserForm">
        <label>First Name:</label>
        <input id="editFirstName" type="text">
        <label>Last Name</label>
        <input id="editLastName" type="text">
        <label>Role</label>
        <select id="editRole">
          <option value="Admin">Admin</option>
          <option value="Manager">Manager</option>
          <option value="Accountant">Accountant</option>
        </select>
        <label>Active</label>
        <input id="editActive" type="checkbox">
        <!-- hidden native submit kept to ensure form.requestSubmit() triggers form's submit event -->
        <input id="hiddenEditSubmit" type="submit" value="Submit" style="display:none">
        <label>Suspend User:</label>
        <div class="suspend-dates">
          <label>Start:</label>
          <input id="editSuspendStart" type="date">
          <label>End:</label>
          <input id="editSuspendEnd" type="date">
        </div>
      </form>
      
      <div class="popup-buttons">
        <button id="saveButton" type="button">Save</button>
        <button class='popup-cancel' id="cancelButton">Cancel</button>
        <button class='popup-delete' id="deleteButton">Delete</button>
      </div>
    </div>


    <!--Pending Users Pop-up Display-->
    <div class="popup-pending" id="pendingPopup">
      <h3>Pending Users</h3>
      <div class="table-wrap">
        <table id="pendingTable">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

      <!--Creating New Users-->
    <div class="popup" id="newPopup">
      <h3>Create New Users</h3>
      <hr>
      <form id="newUserForm" onsubmit="return createNewUser(event)">
        <label>Name:</label>
        <input name="firstName" type="text" placeholder="First Name" required>
        <input name="lastName" type="text" placeholder='Last Name' required>
        <label>Email:</label>
        <input name="addEmail" type="email" placeholder='Email' required>
        <label>Address:</label>
        <input name="address" type="text" placeholder="Address">
        <Label>Birthday:</Label>
        <input name="dob" type="date" required>
        <label>Role:</label>
        <select name ='role'>
          <option value="Accountant">Accountant</option>
          <option value="Manager">Manager</option>
          <option value="Admin">Admin</option>
        </select>
        <lable>Password:</lable>
        <input name="enterPassword" type="password" placeholder='Enter Password' required>
        <input name="confirmPassword" tpye="password" placeholder='Confirm Password' required>
      </form>

      <p id="username">This text is where it gonna show your username</p>

      <div class="popup-buttons">
        <button id="sumbitButton" type="submit" form="newUserForm">Submit</button>
        <button class='popup-cancel' id="closeButton">Cancel</button>

      </div>
    </div>

  </main>

</div>

<script src="'users.js">
  
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>
<script type="module">

  //Import createClient from global supabase object
  const { createClient } = supabase;

  //Supabase project info
  const SUPABASE_URL = "https://rsthdogcmqwcdbqppsrm.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJzdGhkb2djbXF3Y2RicXBwc3JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNTY3NDcsImV4cCI6MjA3MTYzMjc0N30.EoOxjSIjGHbw6ltNisWYq6yKXdrOfE6XVdh5mERbrSY";

  //Initialize Supabase client
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.USE_SUPABASE = true;

  //Load users onto a table
  async function getUsers() {
    const {data, error} = await supabaseClient
      .from('users')
      .select('*')
      .eq('approved', true);

      const tableBody = document.getElementById('userTable').getElementsByTagName('tbody')[0];
      tableBody.innerHTML = ''; // Clear existing rows

      data.forEach(user => {
        const newRow = tableBody.insertRow();

        const email = newRow.insertCell(0);
        email.textContent = user.email;

        const name = newRow.insertCell(1);
        name.textContent = user.first_name + " " + user.last_name;

        const role = newRow.insertCell(2);
        role.textContent = user.role;

        const active = newRow.insertCell(3);
        active.textContent = user.active ? '✅' : '❌';

        //Action Buttons

        const actionCell = newRow.insertCell(4);
        const editButton = document.createElement('button');
        editButton.textContent = 'Edit';
        editButton.className = 'edit-btn';
        editButton.onclick = () => showEditPopup(user);
        actionCell.appendChild(editButton);


      });
  }

   async function showEditPopup(user) {
      // Fill the form with current user data
      document.getElementById('editFirstName').value = user.first_name;
      document.getElementById('editLastName').value = user.last_name;
      document.getElementById('editRole').value = user.role;
      document.getElementById('editActive').checked = user.active;

      document.getElementById('editSuspendStart').value = user.suspend_start || '';
      document.getElementById('editSuspendEnd').value = user.suspend_end || '';

      // Show the popup
      document.getElementById('popupOverlay').style.display = 'block';
      document.getElementById('editPopup').style.display = 'block';

      // Handle form submission
      const form = document.getElementById('editUserForm');
      form.onsubmit = async (e) => {
          e.preventDefault();
          const updates = {
            first_name: document.getElementById('editFirstName').value,
            last_name: document.getElementById('editLastName').value,
            role: document.getElementById('editRole').value,
            active: document.getElementById('editActive').checked,
            suspend_start: document.getElementById('editSuspendStart').value || null,
            suspend_end: document.getElementById('editSuspendEnd').value || null
          };

          const today = new Date().toISOString().split('T')[0]; // yyyy-mm-dd
          if (updates.suspend_start && updates.suspend_end) {
            if (today >= updates.suspend_start && today <= updates.suspend_end) {
              updates.active = false;
            } else {
              updates.active = true;
            }
          }

          const success = await updateUser(user.id, updates);
          if (success) {
              await getUsers(); // Refresh the table with updated data
              closePopup();
          }
      };

      // Wire up delete button
      const deleteBtn = document.getElementById('deleteButton');
      if (deleteBtn) {
          // Use onclick to ensure only one handler is attached
          deleteBtn.onclick = async () => {
              await deleteUser(user.id);
              // Refresh table and close popup after successful deletion
              await getUsers();
              closePopup();
          };
      }

      
  }
  //Updates users information
  async function updateUser(userID, updates) {
    const { error } = await supabaseClient
      .from('users')
      .update({
        first_name: updates.first_name,
        last_name: updates.last_name,
        role: updates.role,
        active: updates.active,
        suspend_start: updates.suspend_start,
        suspend_end: updates.suspend_end
      })
      .eq('id', userID);

    if (error) {
      console.error("Error updating user:", error);
      return false;
    }
    return true;
  }


  //Deletes the user from the database
  async function deleteUser(userID) {
    const text = "Do you wish to reject this user?";
    if (confirm(text) !== true) {
      return false;
    }

    const {error} = await supabaseClient
      .from('users')
      .delete()
      .eq('id', userID);

    if (error) {
      console.error('Error rejecting user:', error);
      return false;
    }

    return true;
  }

  function closePopup() {
    document.getElementById('popupOverlay').style.display = 'none';
    document.getElementById('editPopup').style.display = 'none';
    document.getElementById('pendingPopup').style.display = 'none';
    document.getElementById('newPopup').style.display = 'none';
  }

  document.getElementById('popupOverlay').onclick = closePopup;
  document.getElementById('cancelButton').onclick = closePopup;
  document.getElementById('closeButton').onclick = closePopup;
    
    getUsers();

    // Logout functionality
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
      try { 
        if (window.supabaseClient?.auth) await window.supabaseClient.auth.signOut(); 
      } catch(e){}
      localStorage.removeItem('username');
      location.href = 'HornetHiveLogin.html';
    });

  // Wire Save button to submit the edit form
  const saveBtn = document.getElementById('saveButton');
  const editForm = document.getElementById('editUserForm');
  if (saveBtn && editForm) {
    saveBtn.addEventListener('click', () => {
      // Use requestSubmit to trigger the form's submit event and validation
      if (typeof editForm.requestSubmit === 'function') editForm.requestSubmit();
      else editForm.dispatchEvent(new Event('submit', {cancelable: true}));
    });
  }

  document.getElementById('queryUsers').onclick = showPendingPopup;
  async function showPendingPopup() {
    document.getElementById('popupOverlay').style.display = 'block';
    document.getElementById('pendingPopup').style.display = 'block';

    //Prints users onto the table
    const tableBody = document.getElementById('pendingTable').getElementsByTagName('tbody')[0];
    tableBody.innerHTML = ''; // Clear existing rows

    const {data, error} = await supabaseClient
      .from('users')
      .select('*')
      .eq('approved', false);

    data.forEach(user => {
        const newRow = tableBody.insertRow();

        const email = newRow.insertCell(0);
        email.textContent = user.email;

        const name = newRow.insertCell(1);
        name.textContent = user.first_name + " " + user.last_name;

        const role = newRow.insertCell(2);
        role.textContent = user.role;

        //Action
        const actionCell = newRow.insertCell(3);
        const approveButton = document.createElement('button');
        approveButton.textContent = 'Approve';
        approveButton.className = 'approve-btn';
        approveButton.onclick = () => approveUser(user.id);

        const rejectButton = document.createElement('button');
        rejectButton.textContent = 'Reject';
        rejectButton.className = 'reject-btn';
        rejectButton.onclick = () => rejectUser(user.id);
        
        actionCell.appendChild(approveButton);
        actionCell.appendChild(rejectButton);
    });

    document.getElementById('confirmReject').onclick = async () => {
    await rejectUser(userID);
    closePopup();
    };
  }

  async function approveUser(userID) {
    const {error} = await supabaseClient
      .from('users')
      .update({approved: true, active: true})
      .eq('id', userID)

      showPendingPopup();
  }

  async function rejectUser(userID) {
    const text = "Do you wish to remove this user?";
    if (confirm(text) !== true) {
      return false;
    }
    const {error} = await supabaseClient
        .from('users')
        .delete()
        .eq('id', userID);

        if (error) {
      console.error('Error deleting user:', error);
      return false;
    }
    showPendingPopup();
    return true; 
  }
    //New Users creation popup
    document.getElementById('createNewUsers').onclick = openNewUser;
    async function openNewUser() {
      //Opens up new users popup
      document.getElementById('popupOverlay').style.display = 'block';
      document.getElementById('newPopup').style.display = 'block';

      // initialize live username preview when opening
      liveUsername();

    }

  //Handles submitting new user request
  async function createNewUser(event) {
    event.preventDefault();
    const first = event.target.firstName.value;
    const last = event.target.lastName.value;
    const dob = event.target.dob.value; // yyyy-mm-dd
    const usernameEl = document.getElementById('username');
    // ensure username is generated before submitting
    const username = usernameEl ? usernameEl.textContent.trim() : '';
    console.log('Submitting new user', { first, last, dob, username });
  }

  function liveUsername() {
    const form = document.getElementById('newUserForm');
    if (!form) return;

    const firstEl = form.querySelector('[name="firstName"]');
    const lastEl = form.querySelector('[name="lastName"]');
    const dobEl = form.querySelector('[name="dob"]');
    const out = document.getElementById('username');

    function build() {
      const first = (firstEl && firstEl.value) ? firstEl.value.trim() : '';
      const last = (lastEl && lastEl.value) ? lastEl.value.trim() : '';
      const dob = (dobEl && dobEl.value) ? dobEl.value : '';

      if (!first || !last || !dob) {
        if (out) out.textContent = 'This text is where it gonna show your username';
        return;
      }

      // take first letter of first name and full last name
      const f = first.charAt(0).toLowerCase();
      // sanitize last name: remove spaces and non-alphanumeric
      const l = last.toLowerCase().replace(/[^a-z0-9]/g, '');

      // dob expected format YYYY-MM-DD -> extract month and day
      const parts = dob.split('-');
      let mmdd = '';
      if (parts.length === 3) {
        const mm = parts[1].padStart(2, '0');
        const dd = parts[2].padStart(2, '0');
        mmdd = `${mm}${dd}`;
      }

      const username = `${f}${l}${mmdd}`;
      if (out) out.textContent = username;
    }

    // attach listeners once
    if (firstEl && !firstEl._liveUsernameAttached) {
      firstEl.addEventListener('input', build);
      firstEl._liveUsernameAttached = true;
    }
    if (lastEl && !lastEl._liveUsernameAttached) {
      lastEl.addEventListener('input', build);
      lastEl._liveUsernameAttached = true;
    }
    if (dobEl && !dobEl._liveUsernameAttached) {
      dobEl.addEventListener('change', build);
      dobEl._liveUsernameAttached = true;
    }

    // initial build
    build();
  }

</script>

<style>
  #helpBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #0a58ca;
    color: #fff;
    padding: 10px 14px;
    border-radius: 50px;
    cursor: pointer;
    border: none;
    font-size: 15px;
    z-index: 1100;
    box-shadow: 0 2px 6px rgba(0,0,0,.25);
  }

  #helpOverlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    align-items: center;
    justify-content: center;
    z-index: 1200;
  }
  #helpOverlay.show { display: flex; }

  .help-card {
    background: #fff;
    width: 90%;
    max-width: 750px;
    border-radius: 12px;
    padding: 1.4rem 1.75rem;
    max-height: 85vh;
    overflow-y: auto;
  }

  .help-card h2 { margin-top: 0; }
  .help-topic { margin-bottom: 1.2rem; }
  .help-topic h3 { margin-bottom: 0.4rem; color: #0a58ca; }
</style>

<button id="helpBtn">Help</button>

<div id="helpOverlay">
  <div class="help-card">
    <button id="closeHelp" style="float:right; cursor:pointer;">Close ✕</button>
    <h2>Help & Documentation</h2>

    <div class="help-topic">
      <h3>Financial Ratios</h3>
      <p>Used to evaluate performance and financial health. Includes liquidity ratios (current ratio), profitability ratios (net profit margin), and solvency ratios (debt-to-equity).</p>
    </div>

    <div class="help-topic">
      <h3>Accounts</h3>
      <p>Individual record categories that track increases and decreases in assets, liabilities, equity, revenue, and expenses.</p>
    </div>

    <div class="help-topic">
      <h3>Chart of Accounts</h3>
      <p>A structured list of all accounts in the system. Organized by type and number. Used as the foundation for all financial recordkeeping.</p>
    </div>

    <div class="help-topic">
      <h3>Balance Sheet</h3>
      <p>A financial statement showing assets, liabilities, and equity at a specific point in time. Follows: Assets = Liabilities + Equity.</p>
    </div>

    <div class="help-topic">
      <h3>Event Logs</h3>
      <p>Tracks actions taken by users such as logins, account changes, journal entries, and administrative updates for auditability.</p>
    </div>

    <div class="help-topic">
      <h3>Income Statement</h3>
      <p>Shows revenues and expenses over a period of time, resulting in net income or net loss.</p>
    </div>

    <div class="help-topic">
      <h3>Journals</h3>
      <p>The first place transactions are recorded. Each journal entry includes debits and credits to the relevant accounts.</p>
    </div>

    <div class="help-topic">
      <h3>Ledgers</h3>
      <p>Contains all transactions for a single account. Shows running balances and is used to prepare financial statements.</p>
    </div>

    <div class="help-topic">
      <h3>Retained Earnings</h3>
      <p>Cumulative net income kept in the business after dividends are paid. Updated at the end of each accounting period.</p>
    </div>

    <div class="help-topic">
      <h3>Trial Balance</h3>
      <p>A report listing all ending account balances to ensure total debits equal total credits. Helps identify recording errors.</p>
    </div>

    <div class="help-topic">
      <h3>Users</h3>
      <p>Administrators and staff who have access to the system. Permissions determine who may view, edit, or approve entries.</p>
    </div>

  </div>
</div>

<script>
  const helpBtn = document.getElementById('helpBtn');
  const helpOverlay = document.getElementById('helpOverlay');
  const closeHelp = document.getElementById('closeHelp');

  helpBtn.addEventListener('click', () => helpOverlay.classList.add('show'));
  closeHelp.addEventListener('click', () => helpOverlay.classList.remove('show'));

  helpOverlay.addEventListener('click', (e) => {
    if (e.target === helpOverlay) helpOverlay.classList.remove('show');
  });
</script>

</body>
</html>
