<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ledger</title>
  <link rel="stylesheet" href="main.css">
  <style>
    /* small styles to match your example look */
    .page-title {font-size: 2.25rem; font-weight:700; color:#15803d; margin:0 0 .5rem}
    .toolbar {display:flex; justify-content:flex-end; gap:.5rem; margin:.25rem 0 1rem}
    .toolbar input {padding:.45rem .6rem}
    .ledger-card {background:#fff; border-radius:12px; padding:1rem; box-shadow:0 1px 4px rgba(0,0,0,.08)}
    .table-wrap table {width:100%; border-collapse:collapse}
    th, td {padding:.65rem .6rem; border-top:1px solid #e5e7eb; text-align:left}
    th {background:#f8fafc; font-weight:600}
    .btn-back {margin-top:1rem; padding:.45rem .7rem; background:#0f172a; color:#fff; border-radius:8px}
    .ref a {text-decoration:underline; color:#2563eb}
    .money {text-align:right; white-space:nowrap}
  </style>
</head>

<body class="has-sidebar">
<header class="topbar">
  <div class="datetime" id="dateTime"></div>
  <div class="user">
    <img id="userAvatar" src="profile.png" alt="User">
    <span id="userName"></span>
  </div>
</header>

<script>
  const name = localStorage.getItem('username') || 'User';
  const el = document.getElementById('userName');
  if (el) el.textContent = name;

  function updateClock(){
    const now = new Date();
    const options = { weekday:'short', year:'numeric', month:'short', day:'numeric',
                      hour:'2-digit', minute:'2-digit', second:'2-digit' };
    document.getElementById('dateTime').textContent = now.toLocaleString(undefined, options);
  }
  updateClock(); setInterval(updateClock,1000);
</script>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <img src="HHAlogo.jpg" alt="HHA Logo"><span>HHA</span>
    </div>
    <ul class="nav">
      <li><a href="Dashboard.html">Dashboard</a></li>
      <li><a href="ChartOfAccounts.html">Chart of Accounts</a></li>
      <li><a href="journal.html">Journalize</a></li>
      <li><a href="trial_balance.html">Trial Balance</a></li>
      <li><a href="#income">Income Statement</a></li>
      <li><a href="#balance">Balance Sheet</a></li>
      <li><a href="#retained">Statement of Retained Earnings</a></li>
    </ul>
    <div class="sidebar-footer"><button class="btn">Logout</button></div>
  </aside>

  <main class="main">
    <div class="ledgerBody">
      <div class="ledger-card">
        <h1 id="ledgerTitle" class="page-title">â€”</h1>

        <div class="toolbar">
          <input id="searchInput" type="text" placeholder="Search description or amount">
          <button id="searchBtn" class="btn">Search</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="min-width:110px">Date</th>
                <th>Reference No.</th>
                <th>Description</th>
                <th class="money">Debit</th>
                <th class="money">Credit</th>
                <th class="money">Balance</th>
              </tr>
            </thead>
            <tbody id="ledgerTableBody">
              <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <a href="ChartOfAccounts.html" class="btn-back">&lt; Back to Accounts</a>
      </div>
    </div>
  </main>
</div>

<!-- Supabase & Auth -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>

<script>
  const db = window.supabaseClient;

  // URL params: ?account_id=123
  const params = new URLSearchParams(window.location.search);
  const accountId = params.get("account_id");

  async function loadLedger() {
    const tbody = document.getElementById("ledgerTableBody");
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>`;

    if (!accountId) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:red;">No account selected</td></tr>`;
      return;
    }

    // Fetch account info
    const { data: acc, error: accErr } = await db
      .from("accounts")
      .select("account_name, account_number, normal_side")
      .eq("account_id", accountId)
      .maybeSingle();

    if (accErr || !acc) {
      console.error("Error loading account:", accErr);
      document.getElementById("ledgerTitle").textContent = "Ledger";
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:red;">Failed to load account</td></tr>`;
      return;
    }

    // Title like "100 - Cash"
    document.getElementById("ledgerTitle").textContent = `${acc.account_number} - ${acc.account_name}`;

    // Fetch ledger rows for this account_number
    const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();

    const { data, error } = await db
      .from("ledger")
      .select("journal_entry_id, date, description, debit, credit, balance")
      .eq("account_number", acc.account_number)
      .order("date", { ascending: true })
      .order("created_at", { ascending: true });

    if (error) {
      console.error("Ledger load error:", error);
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:red;">Error loading ledger</td></tr>`;
      return;
    }

    // client-side search
    let rows = data || [];
    if (q) {
      rows = rows.filter(r => {
        const desc = (r.description || "").toLowerCase();
        const dAmt = Number(r.debit || 0).toFixed(2);
        const cAmt = Number(r.credit || 0).toFixed(2);
        return desc.includes(q) || dAmt.includes(q) || cAmt.includes(q);
      });
    }

    // Render
tbody.innerHTML = "";
if (!rows.length) {
  tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No entries</td></tr>`;
  return;
}

// Recompute running balance from 0 (or use initial balance if you prefer)
const isDebitNormal = (acc.normal_side || "").toLowerCase() === "debit";
let running = 0; // or: Number(acc.initial_balance || 0);

// sort strictly by (date, created_at) to be safe
rows.sort((a,b) => {
  const da = new Date(a.date || a.created_at || 0).getTime();
  const db = new Date(b.date || b.created_at || 0).getTime();
  if (da !== db) return da - db;
  return 0;
});

rows.forEach(r => {
  const dateStr = r.date ? new Date(r.date).toLocaleDateString() : "";
  const debitVal  = Number(r.debit  || 0);
  const creditVal = Number(r.credit || 0);

  // delta based on normal side
  const delta = isDebitNormal
    ? (debitVal - creditVal)   // debit-normal: debits increase, credits decrease
    : (creditVal - debitVal);  // credit-normal: credits increase, debits decrease

  running = Number((running + delta).toFixed(2));

  const refHtml = r.journal_entry_id
    ? `<a class="ref" href="journal.html?entry_id=${r.journal_entry_id}">${r.journal_entry_id}</a>`
    : "";

  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${dateStr}</td>
    <td class="ref">${refHtml}</td>
    <td>${r.description || ""}</td>
    <td class="money">${debitVal ? debitVal.toFixed(2) : ""}</td>
    <td class="money">${creditVal ? creditVal.toFixed(2) : ""}</td>
    <td class="money">${running.toFixed(2)}</td>
  `;
  tbody.appendChild(tr);
});

  }

  document.getElementById("searchBtn")?.addEventListener("click", loadLedger);
  document.addEventListener("DOMContentLoaded", loadLedger);
</script>
</body>
</html>
